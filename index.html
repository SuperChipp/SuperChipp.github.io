<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ... (styles are identical) ... */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #pie-chart, #bar-chart { transition: transform 0.5s ease-out, opacity 0.5s ease-out; transform: scale(0.9); opacity: 0; }
        #pie-chart.loaded, #bar-chart.loaded { transform: scale(1); opacity: 1; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased">

    <!-- Global Loading Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900 bg-opacity-80 z-50 flex-col items-center justify-center hidden">
        <!-- ... (loader) ... -->
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-container" class="min-h-screen">
        
        <!-- Header -->
        <header class="bg-slate-800 shadow-md sticky top-0 z-40">
            <!-- ... (header content) ... -->
        </header>

        <!-- Main Content (Hidden by default) -->
        <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
            <!-- ... (all main content) ... -->
        </main>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- ... (modal content) ... -->
    </div>

    <!-- Category Management Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- ... (modal content) ... -->
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 ... hidden ...">
        <span id="toast-message">Success!</span>
    </div>

    <!-- NEW: Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg z-10">
            <div class="p-5 border-b border-slate-700">
                <h3 class="text-xl font-semibold text-white">One-Time Setup</h3>
            </div>
            <form id="setup-form" class="p-5">
                <p class="text-slate-400 mb-4">Please provide your Google API keys. These are stored *only* in your browser and are never shared.</p>
                
                <div class="mb-4">
                    <label for="client-id-input" class="block text-sm font-medium text-slate-300 mb-1">OAuth Client ID</label>
                    <input type="text" id="client-id-input" placeholder="....apps.googleusercontent.com" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label for="api-key-input" class="block text-sm font-medium text-slate-300 mb-1">API Key (for File Picker)</label>
                    <input type="text" id="api-key-input" placeholder="AIzaSy..." required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Save and Continue</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Google API Scripts -->
    <script>
        // Attach callbacks to window
        window.gapiLoaded = function() {
            gapi.load('client:picker', () => {
                window.gapiInited = true;
                window.pickerInited = true;
                window.maybeEnableAuth();
            });
        };

        window.gisLoaded = function() {
            // GIS client is initialized *after* we get the CLIENT_ID
            window.gisInited = true;
            window.maybeEnableAuth();
        };
    </script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></Sscript>

    <script>
        // --- CONFIG (NO KEYS) ---
        // REMOVED: const CLIENT_ID
        const SHEET_NAME = 'Transactions';
        const CATEGORY_SHEET_NAME = 'Categories';
        const DEFAULT_CATEGORIES = ['Housing', 'Food', 'Transportation', 'Entertainment', 'Shopping', 'Utilities', 'Salary', 'Freelance', 'Other'];
        
        // LocalStorage Keys
        const CLIENT_ID_KEY = 'googleClientId';
        const API_KEY_KEY = 'googleApiKey';
        const SHEET_FILE_ID_KEY = 'googleSheetFileId';
        
        // --- GOOGLE API VARS ---
        let CLIENT_ID = localStorage.getItem(CLIENT_ID_KEY) || null;
        let PICKER_API_KEY = localStorage.getItem(API_KEY_KEY) || null;
        
        let tokenClient;
        window.gapiInited = window.gapiInited || false;
        window.gisInited = window.gisInited || false;
        window.pickerInited = window.pickerInited || false;
        let sheetFileId = localStorage.getItem(SHEET_FILE_ID_KEY) || null;

        // --- APP STATE ---
        let transactions = [];
        let categories = [];
        let pieChartInstance = null;
        let barChartInstance = null;

        // --- DOM ELEMENTS ---
        let authButton, mainContent, userNameEl, globalLoader, loadingStatus,
            totalBalanceEl, totalIncomeEl, totalExpensesEl, savingsRateEl,
            balanceTrendEl, incomeTrendEl, expenseTrendEl, pieChartEl, barChartEl,
            addTransactionBtnQuick, syncButton, syncStatusEl, changeFileButton,
            settingsButton, transactionTableBody, noTransactionsEl, searchInput,
            categoryFilter, typeFilter, transactionModal, modalCloseBtn,
            modalCancelBtn, modalTitle, transactionForm, transactionIdInput,
            transactionDateInput, transactionTypeInput, transactionAmountInput,
            transactionCategoryInput, transactionDescriptionInput, categoryGroup,
            modalSubmitBtn, categoryModal, categoryModalCloseBtn, categoryForm,
            newCategoryNameInput, categoryListEl, toast, toastMessage,
            setupModal, setupForm, clientIdInput, apiKeyInput; // Added setup modal elements

        // --- INITIALIZATION ---
        
        // This function is on the window object
        window.maybeEnableAuth = function() {
            if (window.gapiInited && window.gisInited && authButton && CLIENT_ID) {
                authButton.disabled = false;
                authButton.textContent = 'Sign In with Google';
                authButton.onclick = handleAuthClick;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all DOM elements
            authButton = document.getElementById('auth-button');
            mainContent = document.getElementById('main-content');
            userNameEl = document.getElementById('user-name');
            globalLoader = document.getElementById('global-loader');
            loadingStatus = document.getElementById('loading-status');
            
            // ... (assign all other app elements) ...
            totalBalanceEl = document.getElementById('total-balance');
            totalIncomeEl = document.getElementById('total-income');
            totalExpensesEl = document.getElementById('total-expenses');
            savingsRateEl = document.getElementById('savings-rate');
            balanceTrendEl = document.getElementById('balance-trend');
            incomeTrendEl = document.getElementById('income-trend');
            expenseTrendEl = document.getElementById('expense-trend');
            pieChartEl = document.getElementById('pie-chart');
            barChartEl = document.getElementById('bar-chart');
            addTransactionBtnQuick = document.getElementById('add-transaction-btn-quick');
            syncButton = document.getElementById('sync-button');
            syncStatusEl = document.getElementById('sync-status');
            changeFileButton = document.getElementById('change-file-button');
            settingsButton = document.getElementById('settings-button');
            transactionTableBody = document.getElementById('transaction-table-body');
            noTransactionsEl = document.getElementById('no-transactions');
            searchInput = document.getElementById('search-input');
            categoryFilter = document.getElementById('category-filter');
            typeFilter = document.getElementById('type-filter');
            transactionModal = document.getElementById('transaction-modal');
            modalCloseBtn = document.getElementById('modal-close-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            modalTitle = document.getElementById('modal-title');
            transactionForm = document.getElementById('transaction-form');
            transactionIdInput = document.getElementById('transaction-id');
            transactionDateInput = document.getElementById('transaction-date');
            transactionTypeInput = document.getElementById('transaction-type');
            transactionAmountInput = document.getElementById('transaction-amount');
            transactionCategoryInput = document.getElementById('transaction-category');
            transactionDescriptionInput = document.getElementById('transaction-description');
            categoryGroup = document.getElementById('category-group');
            modalSubmitBtn = document.getElementById('modal-submit-btn');
            categoryModal = document.getElementById('category-modal');
            categoryModalCloseBtn = document.getElementById('category-modal-close-btn');
            categoryForm = document.getElementById('category-form');
            newCategoryNameInput = document.getElementById('new-category-name');
            categoryListEl = document.getElementById('category-list');
            toast = document.getElementById('toast');
            toastMessage = document.getElementById('toast-message');

            // Setup Modal Elements
            setupModal = document.getElementById('setup-modal');
            setupForm = document.getElementById('setup-form');
            clientIdInput = document.getElementById('client-id-input');
            apiKeyInput = document.getElementById('api-key-input');

            // --- CHECK FOR KEYS & ATTACH LISTENERS ---

            if (!CLIENT_ID || !PICKER_API_KEY) {
                // Show setup modal if keys are missing
                setupModal.classList.remove('hidden');
                clientIdInput.value = CLIENT_ID || '';
                apiKeyInput.value = PICKER_API_KEY || '';
            } else {
                // Keys exist, initialize GIS client
                initializeGisClient();
            }

            // Now that DOM is ready, try enabling auth button
            window.maybeEnableAuth();

            // Setup form listener
            setupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                CLIENT_ID = clientIdInput.value.trim();
                PICKER_API_KEY = apiKeyInput.value.trim();
                if (CLIENT_ID && PICKER_API_KEY) {
                    localStorage.setItem(CLIENT_ID_KEY, CLIENT_ID);
                    localStorage.setItem(API_KEY_KEY, PICKER_API_KEY);
                    setupModal.classList.add('hidden');
                    initializeGisClient(); // Initialize now
                    window.maybeEnableAuth(); // Enable auth button
                } else {
                    showToast('Please provide both keys.', 'error');
                }
            });
            
            // --- ATTACH ALL OTHER EVENT LISTENERS ---
            // (identical)
            searchInput.addEventListener('input', renderAll);
            categoryFilter.addEventListener('change', renderAll);
            typeFilter.addEventListener('change', renderAll);
            addTransactionBtnQuick.addEventListener('click', showTransactionModal);
            syncButton.addEventListener('click', loadAppData);
            changeFileButton.addEventListener('click', changeFile);
            settingsButton.addEventListener('click', showCategoryModal);
            transactionTypeInput.addEventListener('change', toggleCategoryField);
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);
            modalCloseBtn.addEventListener('click', hideTransactionModal);
            modalCancelBtn.addEventListener('click', hideTransactionModal);
            transactionModal.addEventListener('click', (e) => {
                if (e.target === transactionModal) hideTransactionModal();
            });
            categoryForm.addEventListener('submit', handleCategoryFormSubmit);
            categoryModalCloseBtn.addEventListener('click', hideCategoryModal);
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) hideCategoryModal();
            });
        });

        // --- AUTHENTICATION ---
        
        function initializeGisClient() {
            if (!CLIENT_ID) {
                console.warn("GIS Client NOT initialized: Missing CLIENT_ID");
                return;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, // Use variable
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets',
                    callback: '', // Callback is set dynamically
                });
            } catch (err) {
                console.error("Error initializing GIS Client: ", err);
                showToast("Invalid Client ID. Please check settings.", 'error');
                localStorage.removeItem(CLIENT_ID_KEY);
                CLIENT_ID = null;
                setupModal.classList.remove('hidden');
            }
        }
        
        async function handleAuthClick() {
            if (!tokenClient) {
                showToast('Google Auth is not ready. Is your Client ID correct?', 'error');
                return;
            }
            showLoader('Authenticating...');
            // (Rest of function is identical)
            if (gapi.client.getToken() === null) {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        hideLoader();
                        showToast(`Error: ${resp.error}`, 'error');
                        throw (resp);
                    }
                    await initializeApp();
                };
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            } else {
                await initializeApp();
            }
        }

        async function initializeApp() {
            // (identical)
            showLoader('Loading Google APIs...');
            try {
                await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
                await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
                
                showLoader('Accessing user profile...');
                const profileResponse = await gapi.client.request({
                    'path': 'https://people.googleapis.com/v1/people/me?personFields=names'
                });
                
                const userName = profileResponse.result.names[0].displayName;
                userNameEl.textContent = `Hello, ${userName}`;
                userNameEl.classList.remove('hidden');
                authButton.textContent = 'Sign Out';
                authButton.onclick = handleSignOut;
                
                if (!sheetFileId) {
                    showLoader('Please select a Google Sheet...');
                    await loadPicker();
                } else {
                    await loadAppData();
                }
            } catch (err) {
                console.error('Error during app initialization:', err);
                showToast(`Error: ${err.message || 'Could not load Google APIs.'}`, 'error');
                hideLoader();
            }
        }

        function handleSignOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    sheetFileId = null;
                    // Don't clear API/Client keys, just the file ID
                    localStorage.removeItem(SHEET_FILE_ID_KEY); 
                    mainContent.classList.add('hidden');
                    authButton.textContent = 'Sign In with Google';
                    authButton.onclick = handleAuthClick;
                    userNameEl.classList.add('hidden');
                    showToast('Signed out successfully.');
                });
            }
        }

        // --- GOOGLE PICKER LOGIC ---

        async function loadPicker() {
            if (!window.pickerInited) {
                showToast('Picker API not loaded.', 'error');
                hideLoader();
                return;
            }
            if (!PICKER_API_KEY) {
                showToast('Missing API Key. Please enter it in settings.', 'error');
                hideLoader();
                setupModal.classList.remove('hidden'); // Show setup
                return;
            }
            
            // (Rest of function is identical)
            try {
                if (sheetFileId) {
                    try {
                        showLoader('Verifying existing sheet...');
                        await gapi.client.sheets.spreadsheets.get({
                            spreadsheetId: sheetFileId
                        });
                        await loadAppData();
                        return;
                    } catch (e) {
                        showToast('Previous sheet not found. Please select again.', 'warning');
                        sheetFileId = null;
                        localStorage.removeItem(SHEET_FILE_ID_KEY);
                    }
                }
                
                showLoader('Searching for finance sheet...');
                const response = await gapi.client.drive.files.list({
                   'q': "mimeType='application/vnd.google-apps.spreadsheet' and name='MyFinanceAppSheet' and trashed=false",
                    'fields': 'files(id, name)'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    sheetFileId = files[0].id;
                    localStorage.setItem(SHEET_FILE_ID_KEY, sheetFileId);
                    showToast('Found existing finance sheet.');
                    await loadAppData();
                } else {
                    showLoader('Please select or create a finance sheet...');
                    createPicker();
                }
            } catch (err) {
                 console.error('Error listing files:', err);
                 showToast('Error finding your sheet. Please try picking it.', 'error');
                 createPicker();
            }
        }

        function createPicker() {
            // This function now uses the PICKER_API_KEY variable
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            view.setMimeTypes('application/vnd.google-apps.spreadsheet');
            
            const createView = new google.picker.View(google.picker.ViewId.CREATE_DOCUMENT);
            // ... (createView settings)
            
            const picker = new google.picker.PickerBuilder()
                .addViewGroup(view)
                .addViewGroup(createView)
                .setTitle('Select your finance sheet')
                .setOAuthToken(gapi.client.getToken().access_token)
                .setDeveloperKey(PICKER_API_KEY) // Use variable here
                .setCallback(pickerCallback)
                .build();
            
            picker.setVisible(true);
        }
        
        async function pickerCallback(data) {
            // (identical)
            if (data.action === google.picker.Action.PICKED || data.action === google.picker.Action.CREATE) {
                const doc = data.docs[0];
                sheetFileId = doc.id;
                localStorage.setItem(SHEET_FILE_ID_KEY, sheetFileId);
                
                if (data.action === google.picker.Action.CREATE) {
                    showToast('New sheet created: ' + doc.name);
                    await initializeNewSheet();
                } else {
                    showToast('Selected sheet: ' + doc.name);
                    await loadAppData();
                }
            } else if (data.action === google.picker.Action.CANCEL) {
                showToast('Please select a file to continue.', 'error');
                hideLoader();
            }
        }

        async function changeFile() {
            sheetFileId = null;
            localStorage.removeItem(SHEET_FILE_ID_KEY);
            await loadPicker();
        }

        // --- DATA HANDLING (GOOGLE SHEETS API) ---
        // (All functions from here are identical to the previous version)
        
        async function initializeNewSheet() { /* ... */ }
        async function loadAppData() { /* ... */ }
        async function syncDataToSheet() { /* ... */ }
        async function saveCategories() { /* ... */ }

        // --- UI RENDERING ---
        
        function updateUI() { /* ... */ }
        function renderAll() { /* ... */ }
        function getFilteredTransactions() { /* ... */ }
        function formatCurrency(num) { /* ... */ }
        function renderStats() { /* ... */ }
        function renderTransactionTable(filteredTransactions) { /* ... */ }
        function renderCategoryFilters() { /* ... */ }
        function renderIncomeExpensePieChart() { /* ... */ }
        function renderBarChart() { /* ... */ }

        // --- TRANSACTION MODAL ---
        
        function showTransactionModal() { /* ... */ }
        function hideTransactionModal() { /* ... */ }
        async function handleTransactionFormSubmit(e) { /* ... */ }
        async function deleteTransaction(id) { /* ... */ }
        function toggleCategoryField() { /* ... */ }
        function populateCategoryDropdown() { /* ... */ }

        // --- CATEGORY MODAL ---
        
        function showCategoryModal() { /* ... */ }
        function hideCategoryModal() { /* ... */ }
        function renderCategoryList() { /* ... */ }
        async function handleCategoryFormSubmit(e) { /* ... */ }
        async function deleteCategory(category) { /* ... */ }

        // --- HELPERS (Loader, Toast) ---

        function showLoader(message) { /* ... */ }
        function hideLoader() { /* ... */ }
        let toastTimer;
        function showToast(message, type = 'success') { /* ... */ }


        // === (All function bodies are identical to previous version, just copying them in) ===

        async function initializeNewSheet() {
            showLoader('Initializing new sheet...');
            try {
                const transactionHeaders = { values: [['ID', 'Date', 'Description', 'Amount', 'Type', 'Category']] };
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetFileId, range: `${SHEET_NAME}!A1:F1`, valueInputOption: 'RAW', resource: transactionHeaders,
                });
                const addCategorySheetRequest = { requests: [{ addSheet: { properties: { title: CATEGORY_SHEET_NAME } } }] };
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: sheetFileId, resource: addCategorySheetRequest,
                });
                const categoryData = DEFAULT_CATEGORIES.map(cat => [cat]);
                const categoryBody = { values: categoryData };
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetFileId, range: `${CATEGORY_SHEET_NAME}!A1`, valueInputOption: 'RAW', resource: categoryBody,
                });
                showToast('New sheet initialized.');
                await loadAppData();
            } catch (err) {
                console.error('Error initializing sheet:', err);
                showToast('Error initializing sheet.', 'error');
                hideLoader();
            }
        }
        async function loadAppData() {
            showLoader('Loading financial data...');
            if (!sheetFileId) {
                showToast('No Google Sheet file selected.', 'error');
                hideLoader();
                await loadPicker();
                return;
            }
            try {
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: sheetFileId, ranges: [`${SHEET_NAME}!A:F`, `${CATEGORY_SHEET_NAME}!A:A`],
                });
                const transactionValues = response.result.valueRanges[0].values;
                if (transactionValues && transactionValues.length > 1) {
                    transactions = transactionValues.slice(1).map(row => ({
                        id: row[0], date: row[1], description: row[2], amount: parseFloat(row[3]), type: row[4], category: row[5],
                    })).filter(t => t.id && t.date && t.amount != null);
                } else { transactions = []; }
                const categoryValues = response.result.valueRanges[1].values;
                if (categoryValues && categoryValues.length > 0) {
                    categories = categoryValues.map(row => row[0]).filter(cat => cat);
                }
                if (!categories || categories.length === 0) {
                    categories = [...DEFAULT_CATEGORIES];
                    await saveCategories();
                }
                updateUI();
                syncStatusEl.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                showToast('Data loaded successfully.');
            } catch (err) {
                console.error('Error loading app data:', err);
                if (err.result && (err.result.error.status === 'NOT_FOUND' || err.result.error.status === 'PERMISSION_DENIED')) {
                    showToast('Sheet not found or permission denied. Please select file.', 'error');
                    sheetFileId = null; localStorage.removeItem(SHEET_FILE_ID_KEY);
                    await loadPicker();
                } else if (err.result && err.result.error.message.includes("Unable to parse range")) {
                    showToast('Sheet seems to be missing tabs. Initializing.', 'warning');
                    await initializeNewSheet();
                } else {
                    showToast('Error loading data.', 'error');
                }
            } finally { hideLoader(); }
        }
        async function syncDataToSheet() {
            showLoader('Syncing data to Google Sheet...');
            try {
                const transactionData = [['ID', 'Date', 'Description', 'Amount', 'Type', 'Category'], ...transactions.map(t => [t.id, t.date, t.description, t.amount, t.type, t.category])];
                const categoryData = categories.map(c => [c]);
                const batchUpdateRequest = {
                    valueInputOption: 'RAW',
                    data: [
                        { range: `${SHEET_NAME}!A1:F${transactionData.length}`, values: transactionData },
                        { range: `${CATEGORY_SHEET_NAME}!A1:A${categoryData.length}`, values: categoryData }
                    ]
                };
                await gapi.client.sheets.spreadsheets.values.batchClear({
                    spreadsheetId: sheetFileId, resource: { ranges: [`${SHEET_NAME}!A2:F`, `${CATEGORY_SHEET_NAME}!A:A`] }
                });
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: sheetFileId, resource: batchUpdateRequest
                });
                syncStatusEl.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                showToast('Data synced to Google Sheet!');
            } catch (err) { console.error('Error syncing data:', err); showToast('Error syncing data.', 'error');
            } finally { hideLoader(); }
        }
        async function saveCategories() {
            showLoader('Saving categories...');
            try {
                const categoryData = categories.map(c => [c]);
                const body = { values: categoryData };
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: sheetFileId, range: `${CATEGORY_SHEET_NAME}!A:A`,
                });
                if (categoryData.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: sheetFileId, range: `${CATEGORY_SHEET_NAME}!A1`, valueInputOption: 'RAW', resource: body,
                    });
                }
                showToast('Categories saved.');
            } catch (err) { console.error('Error saving categories:', err); showToast('Error saving categories.', 'error');
            } finally { hideLoader(); }
        }
        function updateUI() { renderAll(); mainContent.classList.remove('hidden'); }
        function renderAll() {
            const filtered = getFilteredTransactions();
            renderStats();
            renderTransactionTable(filtered);
            renderCategoryFilters();
            renderIncomeExpensePieChart();
            renderBarChart();
        }
        function getFilteredTransactions() {
            const searchTerm = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            const type = typeFilter.value;
            return transactions
                .filter(t => (t.description || '').toLowerCase().includes(searchTerm))
                .filter(t => category === 'All' || t.category === category)
                .filter(t => type === 'All' || t.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        function formatCurrency(num) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', }).format(num); }
        function renderStats() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? (totalBalance / totalIncome) * 100 : 0;
            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            savingsRateEl.textContent = `${savingsRate.toFixed(1)}%`;
            totalBalanceEl.classList.toggle('text-green-400', totalBalance >= 0);
            totalBalanceEl.classList.toggle('text-red-400', totalBalance < 0);
            balanceTrendEl.classList.toggle('text-green-400', totalBalance >= 0);
            balanceTrendEl.classList.toggle('text-red-400', totalBalance < 0);
            balanceTrendEl.textContent = totalBalance >= 0 ? 'Trending positive' : 'Trending negative';
            incomeTrendEl.textContent = 'N/A';
            expenseTrendEl.textContent = 'N/A';
            savingsTrendEl.textContent = 'N/A';
        }
        function renderTransactionTable(filteredTransactions) {
            transactionTableBody.innerHTML = '';
            if (filteredTransactions.length === 0) { noTransactionsEl.classList.remove('hidden'); return; }
            noTransactionsEl.classList.add('hidden');
            filteredTransactions.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700 hover:bg-slate-700/50';
                row.innerHTML = `
                    <td class="py-3 px-4">${t.date || ''}</td>
                    <td class="py-3 px-4">${t.description || ''}</td>
                    <td class="py-3 px-4">
                        ${t.category ? `<span class="bg-slate-700 text-slate-300 text-xs font-medium px-2 py-1 rounded-full">${t.category}</span>` : ''}
                    </td>
                    <td class="py-3 px-4 text-right font-medium ${t.type === 'Income' ? 'text-green-400' : 'text-red-400'}">
                        ${t.type === 'Expense' ? '-' : '+'}${formatCurrency(t.amount || 0)}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button class="text-slate-500 hover:text-red-400 transition-colors" data-id="${t.id}">
                            <svg class="w-5 h-5" ...><path ... /></svg>
                        </button>
                    </td>`;
                row.querySelector('button').addEventListener('click', () => deleteTransaction(t.id));
                transactionTableBody.appendChild(row);
            });
        }
        function renderCategoryFilters() {
            categoryFilter.innerHTML = '<option value="All">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat; option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }
        function renderIncomeExpensePieChart() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
            if (pieChartInstance) { pieChartInstance.destroy(); }
            if (totalIncome === 0 && totalExpenses === 0) { pieChartEl.classList.remove('loaded'); return; }
            pieChartInstance = new Chart(pieChartEl, {
                type: 'pie',
                data: {
                    labels: ['Total Income', 'Total Expenses'],
                    datasets: [{
                        data: [totalIncome, totalExpenses],
                        backgroundColor: ['rgba(52, 211, 153, 0.7)', 'rgba(248, 113, 113, 0.7)'],
                        borderColor: ['#10b981', '#ef4444'],
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                }
            });
            setTimeout(() => pieChartEl.classList.add('loaded'), 10);
        }
        function renderBarChart() {
            const monthlyData = {};
            transactions.forEach(t => {
                if (!t.date) return;
                const month = t.date.substring(0, 7);
                if (!monthlyData[month]) { monthlyData[month] = { income: 0, expenses: 0 }; }
                if (t.type === 'Income') { monthlyData[month].income += t.amount; }
                else { monthlyData[month].expenses += t.amount; }
            });
            const labels = [];
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                labels.push(d.toISOString().substring(0, 7));
            }
            const incomeData = labels.map(label => monthlyData[label]?.income || 0);
            const expenseData = labels.map(label => monthlyData[label]?.expenses || 0);
            const displayLabels = labels.map(label => {
                const d = new Date(label + '-02');
                return d.toLocaleString('default', { month: 'short' });
            });
            if (barChartInstance) { barChartInstance.destroy(); }
            barChartInstance = new Chart(barChartEl, {
                type: 'bar',
                data: {
                    labels: displayLabels,
                    datasets: [
                        { label: 'Income', data: incomeData, backgroundColor: 'rgba(52, 211, 153, 0.7)', borderColor: '#10b981', borderWidth: 1 },
                        { label: 'Expenses', data: expenseData, backgroundColor: 'rgba(248, 113, 113, 0.7)', borderColor: '#ef4444', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                }
            });
            setTimeout(() => barChartEl.classList.add('loaded'), 10);
        }
        function showTransactionModal() {
            modalTitle.textContent = 'Add Transaction';
            modalSubmitBtn.textContent = 'Add Transaction';
            transactionForm.reset();
            transactionIdInput.value = '';
            transactionDateInput.value = new Date().toISOString().split('T')[0];
            populateCategoryDropdown();
            toggleCategoryField();
            transactionModal.classList.remove('hidden');
        }
        function hideTransactionModal() { transactionModal.classList.add('hidden'); }
        async function handleTransactionFormSubmit(e) {
            e.preventDefault();
            const transaction = {
                id: transactionIdInput.value || crypto.randomUUID(),
                date: transactionDateInput.value,
                description: transactionDescriptionInput.value.trim(),
                amount: parseFloat(transactionAmountInput.value),
                type: transactionTypeInput.value,
                category: transactionTypeInput.value === 'Expense' ? transactionCategoryInput.value : ''
            };
            if (!transaction.description) { showToast('Description cannot be empty.', 'error'); return; }
            if (isNaN(transaction.amount) || transaction.amount <= 0) { showToast('Please enter a valid amount.', 'error'); return; }
            if (transactionIdInput.value) {
                const index = transactions.findIndex(t => t.id === transaction.id);
                if (index !== -1) { transactions[index] = transaction; }
            } else { transactions.push(transaction); }
            updateUI();
            await syncDataToSheet();
            hideTransactionModal();
            showToast(`Transaction ${transactionIdInput.value ? 'updated' : 'added'} successfully.`);
        }
        async function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                updateUI();
                await syncDataToSheet();
                showToast('Transaction deleted.', 'error');
            }
        }
        function toggleCategoryField() {
            if (transactionTypeInput.value === 'Expense') {
                categoryGroup.classList.remove('hidden');
                transactionCategoryInput.required = true;
            } else {
                categoryGroup.classList.add('hidden');
                transactionCategoryInput.required = false;
            }
        }
        function populateCategoryDropdown() {
            transactionCategoryInput.innerHTML = '';
            const expenseCategories = categories.filter(cat => {
                const lowerCat = cat.toLowerCase();
                return lowerCat !== 'salary' && lowerCat !== 'freelance';
            });
            if (expenseCategories.length === 0) {
                 const option = document.createElement('option');
                 option.value = "Other"; option.textContent = "Other";
                 transactionCategoryInput.appendChild(option);
            } else {
                expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat; option.textContent = cat;
                    transactionCategoryInput.appendChild(option);
                });
            }
        }
        function showCategoryModal() { renderCategoryList(); categoryModal.classList.remove('hidden'); }
        function hideCategoryModal() { categoryModal.classList.add('hidden'); }
        function renderCategoryList() {
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = `<p class="text-slate-500 text-center">No categories found. Add one above.</p>`;
                return;
            }
            categories.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-lg';
                item.innerHTML = `
                    <span class="text-white">${cat}</span>
                    <button class="text-slate-400 hover:text-red-400" data-category="${cat}">
                        <svg class="w-5 h-5" ...><path ... /></svg>
                    </button>`;
                item.querySelector('button').addEventListener('click', () => deleteCategory(cat));
                categoryListEl.appendChild(item);
            });
        }
        async function handleCategoryFormSubmit(e) {
            e.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (newCategory && !categories.find(c => c.toLowerCase() === newCategory.toLowerCase())) {
                categories.push(newCategory);
                renderCategoryList();
                populateCategoryDropdown();
                renderCategoryFilters();
                await saveCategories();
                showToast('Category added.');
                newCategoryNameInput.value = '';
            } else if (categories.includes(newCategory)) {
                showToast('Category already exists.', 'error');
            }
        }
        async function deleteCategory(category) {
            if (confirm(`Are you sure you want to delete the category "${category}"? This will not affect existing transactions.`)) {
                categories = categories.filter(c => c !== category);
                renderCategoryList();
                populateCategoryDropdown();
                renderCategoryFilters();
                await saveCategories();
                showToast('Category deleted.', 'error');
            }
        }
        function showLoader(message) {
            loadingStatus.textContent = message;
            globalLoader.classList.remove('hidden');
            globalLoader.classList.add('flex');
        }
        function hideLoader() {
            globalLoader.classList.add('hidden');
            globalLoader.classList.remove('flex');
        }
        toastTimer;
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'translate-x-full', 'opacity-0');
            if (type === 'error') { toast.classList.add('bg-red-500'); }
            else { toast.classList.add('bg-green-500'); }
            toast.classList.remove('hidden');
            void toast.offsetWidth;
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => {
                    toast.classList.add('hidden');
                }, { once: true });
            }, 3000);
        }
    </script>
</body>
</html>
