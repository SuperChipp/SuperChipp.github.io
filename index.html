<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Dark mode scrollbar */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #1e293b; /* slate-800 */ }
        ::-webkit-scrollbar-thumb { background: #475569; /* slate-600 */ border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; /* slate-500 */ }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* Simple loader */
        .loader {
            border: 4px solid #334155; /* slate-700 */
            border-top-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Chart load animation */
        #pie-chart, #bar-chart {
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            transform: scale(0.9);
            opacity: 0;
        }
        #pie-chart.loaded, #bar-chart.loaded {
            transform: scale(1);
            opacity: 1;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased">

    <!-- Global Loading Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900 bg-opacity-80 z-50 flex-col items-center justify-center hidden">
        <div class="loader mb-4"></div>
        <p id="loading-status" class="text-lg text-slate-300">Loading...</p>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-container" class="min-h-screen">
        
        <!-- Header -->
        <header class="bg-slate-800 shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Title -->
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.097V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 3 4.5h.75m12 0v.75A.75.75 0 0 0 15 6h.75m0 0v-.75A.75.75 0 0 0 15 4.5h-.75M5.25 12v.75A.75.75 0 0 1 4.5 13.5h-.75m0 0v-.75A.75.75 0 0 1 4.5 12h.75m12 0v.75A.75.75 0 0 0 16.5 13.5h.75m0 0v-.75A.75.75 0 0 0 16.5 12h-.75m-6 0v.75A.75.75 0 0 1 9 13.5h-.75m0 0v-.75A.75.75 0 0 1 9 12h.75M3 18.75V15a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 15v3.75m-18 0h18" />
                        </svg>
                        <span class="text-xl font-bold text-white">FinTrack</span>
                    </div>
                    
                    <!-- Auth Button & User -->
                    <div class="flex items-center space-x-4">
                        <span id="user-name" class="text-slate-300 text-sm hidden"></span>
                        <button id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-wait" disabled>
                            Loading...
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content (Hidden by default) -->
        <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
            
            <!-- Dashboard Stats -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                <!-- Total Balance -->
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h4 class="text-sm font-medium text-slate-400">Total Balance</h4>
                    <p id="total-balance" class="text-3xl font-bold text-white mt-1">$0.00</p>
                    <p id="balance-trend" class="text-xs text-slate-500 mt-1">N/A</p>
                </div>
                <!-- Total Income -->
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h4 class="text-sm font-medium text-slate-400">Total Income</h4>
                    <p id="total-income" class="text-3xl font-bold text-green-400 mt-1">$0.00</p>
                    <p id="income-trend" class="text-xs text-slate-500 mt-1">N/A</p>
                </div>
                <!-- Total Expenses -->
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h4 class="text-sm font-medium text-slate-400">Total Expenses</h4>
                    <p id="total-expenses" class="text-3xl font-bold text-red-400 mt-1">$0.00</p>
                    <p id="expense-trend" class="text-xs text-slate-500 mt-1">N/A</p>
                </div>
                <!-- Savings Rate -->
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h4 class="text-sm font-medium text-slate-400">Savings Rate</h4>
                    <p id="savings-rate" class="text-3xl font-bold text-blue-400 mt-1">0.0%</p>
                    <p id="savings-trend" class="text-xs text-slate-500 mt-1">N/A</p>
                </div>
            </section>

            <!-- Charts -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <!-- Pie Chart -->
                <div class="lg:col-span-1 bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Income vs Expenses</h3>
                    <div class="chart-container">
                        <canvas id="pie-chart"></canvas>
                    </div>
                </div>
                <!-- Bar Chart -->
                <div class="lg:col-span-2 bg-slate-800 p-5 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold text-white mb-4">Monthly Overview</h3>
                    <div class="chart-container">
                        <canvas id="bar-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="mt-6 bg-slate-800 p-5 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
                <div class="flex flex-wrap gap-4">
                    <button id="add-transaction-btn-quick" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                        Add Transaction
                    </button>
                    <button id="sync-button" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                        Refresh Data
                    </button>
                    <button id="change-file-button" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                        Change Sheet
                    </button>
                    <button id="settings-button" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-5 py-2.5 rounded-lg text-sm font-medium transition-colors">
                        Manage Categories
                    </button>
                    <span id="sync-status" class="text-sm text-slate-400 self-center"></span>
                </div>
            </section>

            <!-- Transaction History -->
            <section class="mt-6 bg-slate-800 rounded-xl shadow-lg">
                <div class="p-5 border-b border-slate-700">
                    <h3 class="text-lg font-semibold text-white">Transaction History</h3>
                    <!-- Filters -->
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <input type="text" id="search-input" placeholder="Search by description..." class="flex-grow bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="category-filter" class="bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Categories</option>
                        </select>
                        <select id="type-filter" class="bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Types</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800">
                            <tr>
                                <th scope="col" class="py-3 px-4">Date</th>
                                <th scope="col" class="py-3 px-4">Description</th>
                                <th scope="col" class="py-3 px-4">Category</th>
                                <th scope="col" class="py-3 px-4 text-right">Amount</th>
                                <th scope="col" class="py-3 px-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                    <div id="no-transactions" class="text-center py-10 text-slate-500 hidden">
                        <p>No transactions found.</p>
                        <p class="text-sm">Try adjusting your filters or add a new transaction.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg z-10">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-slate-700">
                <h3 id="modal-title" class="text-xl font-semibold text-white">Add Transaction</h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal Body -->
            <form id="transaction-form" class="p-5">
                <input type="hidden" id="transaction-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="transaction-date" class="block text-sm font-medium text-slate-300 mb-1">Date</label>
                        <input type="date" id="transaction-date" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-slate-300 mb-1">Type</label>
                        <select id="transaction-type" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="transaction-amount" class="block text-sm font-medium text-slate-300 mb-1">Amount</label>
                    <input type="number" id="transaction-amount" step="0.01" min="0" placeholder="0.00" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="category-group" class="mt-4">
                    <label for="transaction-category" class="block text-sm font-medium text-slate-300 mb-1">Category</label>
                    <select id="transaction-category" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Categories populated by JS -->
                    </select>
                </div>
                <div class="mt-4">
                    <label for="transaction-description" class="block text-sm font-medium text-slate-300 mb-1">Description</label>
                    <input type="text" id="transaction-description" placeholder="e.g. Groceries" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            
                <!-- Modal Footer -->
                <div class="flex justify-end items-center space-x-4 mt-6 pt-5 border-t border-slate-700">
                    <button type="button" id="modal-cancel-btn" class="bg-slate-600 hover:bg-slate-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Cancel</button>
                    <button type="submit" id="modal-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-md z-10">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-5 border-b border-slate-700">
                <h3 class="text-xl font-semibold text-white">Manage Categories</h3>
                <button id="category-modal-close-btn" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-5">
                <form id="category-form" class="flex gap-4">
                    <input type="text" id="new-category-name" placeholder="New category name" required class="flex-grow bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Add</button>
                </form>
                
                <h4 class="text-lg font-semibold text-white mt-6 mb-4">Existing Categories</h4>
                <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Category list populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-5 py-3 rounded-lg shadow-xl text-sm font-medium opacity-0 transition-all duration-300 ease-out hidden" style="transform: translateX(110%);">
        <span id="toast-message">Success!</span>
    </div>
    
    <!-- Setup Modal (For API Keys) -->
    <div id="setup-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg z-10">
            <div class="p-5 border-b border-slate-700">
                <h3 class="text-xl font-semibold text-white">One-Time Setup</h3>
            </div>
            <form id="setup-form" class="p-5">
                <p class="text-slate-400 mb-4">Please provide your Google API keys. These are stored *only* in your browser and are never shared.</p>
                
                <div class="mb-4">
                    <label for="client-id-input" class="block text-sm font-medium text-slate-300 mb-1">OAuth Client ID</label>
                    <input type="text" id="client-id-input" placeholder="....apps.googleusercontent.com" required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label for="api-key-input" class="block text-sm font-medium text-slate-300 mb-1">API Key (for File Picker)</label>
                    <input type="text" id="api-key-input" placeholder="AIzaSy..." required class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">Save and Continue</button>

                </div>
            </form>
        </div>
    </div>

    <!-- 
      ===============================================================
      Main application script
      ===============================================================
    -->
    <script>
        // --- CONFIG (NO KEYS) ---
        const SHEET_NAME = 'Transactions';
        const CATEGORY_SHEET_NAME = 'Categories';
        const DEFAULT_CATEGORIES = ['Housing', 'Food', 'Transportation', 'Entertainment', 'Shopping', 'Utilities', 'Salary', 'Freelance', 'Other'];
        
        // LocalStorage Keys
        const CLIENT_ID_KEY = 'googleClientId';
        const API_KEY_KEY = 'googleApiKey';
        const SHEET_FILE_ID_KEY = 'googleSheetFileId';
        
        // --- GOOGLE API VARS ---
        let CLIENT_ID = localStorage.getItem(CLIENT_ID_KEY) || null;
        let PICKER_API_KEY = localStorage.getItem(API_KEY_KEY) || null;
        
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile';

        let tokenClient;
        window.gapiInited = false;
        window.gisInited = false;
        window.pickerInited = false;
        let sheetFileId = localStorage.getItem(SHEET_FILE_ID_KEY) || null;

        // --- APP STATE ---
        let transactions = [];
        let categories = [];
        let pieChartInstance = null;
        let barChartInstance = null;

        // --- DOM ELEMENTS ---
        let authButton, mainContent, userNameEl, globalLoader, loadingStatus,
            totalBalanceEl, totalIncomeEl, totalExpensesEl, savingsRateEl,
            balanceTrendEl, incomeTrendEl, expenseTrendEl, pieChartEl, barChartEl,
            addTransactionBtnQuick, syncButton, syncStatusEl, changeFileButton,
            settingsButton, transactionTableBody, noTransactionsEl, searchInput,
            categoryFilter, typeFilter, transactionModal, modalCloseBtn,
            modalCancelBtn, modalTitle, transactionForm, transactionIdInput,
            transactionDateInput, transactionTypeInput, transactionAmountInput,
            transactionCategoryInput, transactionDescriptionInput, categoryGroup,
            modalSubmitBtn, categoryModal, categoryModalCloseBtn, categoryForm,
            newCategoryNameInput, categoryListEl, toast, toastMessage,
            setupModal, setupForm, clientIdInput, apiKeyInput;

        // --- INITIALIZATION ---
        
        // This function MUST be defined before the Google scripts load
        window.maybeEnableAuth = function() {
            if (window.gapiInited && window.gisInited && authButton && CLIENT_ID) {
                authButton.disabled = false;
                authButton.textContent = 'Sign In with Google';
                authButton.onclick = handleAuthClick;
            }
        }
        
        // These callbacks MUST be defined before the Google scripts load
        window.gapiLoaded = function() {
            gapi.load('client:picker', () => {
                window.gapiInited = true;
                window.pickerInited = true;
                window.maybeEnableAuth();
            });
        };

        window.gisLoaded = function() {
            window.gisInited = true;
            window.maybeEnableAuth();
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Assign all DOM elements
            authButton = document.getElementById('auth-button');
            mainContent = document.getElementById('main-content');
            userNameEl = document.getElementById('user-name');
            globalLoader = document.getElementById('global-loader');
            loadingStatus = document.getElementById('loading-status');
            
            totalBalanceEl = document.getElementById('total-balance');
            totalIncomeEl = document.getElementById('total-income');
            totalExpensesEl = document.getElementById('total-expenses');
            savingsRateEl = document.getElementById('savings-rate');
            balanceTrendEl = document.getElementById('balance-trend');
            incomeTrendEl = document.getElementById('income-trend');
            expenseTrendEl = document.getElementById('expense-trend');
            pieChartEl = document.getElementById('pie-chart');
            barChartEl = document.getElementById('bar-chart');
            addTransactionBtnQuick = document.getElementById('add-transaction-btn-quick');
            syncButton = document.getElementById('sync-button');
            syncStatusEl = document.getElementById('sync-status');
            changeFileButton = document.getElementById('change-file-button');
            settingsButton = document.getElementById('settings-button');
            transactionTableBody = document.getElementById('transaction-table-body');
            noTransactionsEl = document.getElementById('no-transactions');
            searchInput = document.getElementById('search-input');
            categoryFilter = document.getElementById('category-filter');
            typeFilter = document.getElementById('type-filter');
            transactionModal = document.getElementById('transaction-modal');
            modalCloseBtn = document.getElementById('modal-close-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            modalTitle = document.getElementById('modal-title');
            transactionForm = document.getElementById('transaction-form');
            transactionIdInput = document.getElementById('transaction-id');
            transactionDateInput = document.getElementById('transaction-date');
            transactionTypeInput = document.getElementById('transaction-type');
            transactionAmountInput = document.getElementById('transaction-amount');
            transactionCategoryInput = document.getElementById('transaction-category');
            transactionDescriptionInput = document.getElementById('transaction-description');
            categoryGroup = document.getElementById('category-group');
            modalSubmitBtn = document.getElementById('modal-submit-btn');
            categoryModal = document.getElementById('category-modal');
            categoryModalCloseBtn = document.getElementById('category-modal-close-btn');
            categoryForm = document.getElementById('category-form');
            newCategoryNameInput = document.getElementById('new-category-name');
            categoryListEl = document.getElementById('category-list');
            toast = document.getElementById('toast');
            toastMessage = document.getElementById('toast-message');

            // Setup Modal Elements
            setupModal = document.getElementById('setup-modal');
            setupForm = document.getElementById('setup-form');
            clientIdInput = document.getElementById('client-id-input');
            apiKeyInput = document.getElementById('api-key-input');

            // --- CHECK FOR KEYS & ATTACH LISTENERS ---

            if (!CLIENT_ID || !PICKER_API_KEY) {
                // Show setup modal if keys are missing
                setupModal.classList.remove('hidden');
                clientIdInput.value = CLIENT_ID || '';
                apiKeyInput.value = PICKER_API_KEY || '';
            } else {
                // Keys exist, initialize GIS client
                initializeGisClient();
            }

            // Now that DOM is ready, try enabling auth button
            window.maybeEnableAuth();

            // Setup form listener
            setupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                CLIENT_ID = clientIdInput.value.trim();
                PICKER_API_KEY = apiKeyInput.value.trim();
                if (CLIENT_ID && PICKER_API_KEY) {
                    localStorage.setItem(CLIENT_ID_KEY, CLIENT_ID);
                    localStorage.setItem(API_KEY_KEY, PICKER_API_KEY);
                    setupModal.classList.add('hidden');
                    initializeGisClient(); // Initialize now
                    window.maybeEnableAuth(); // Enable auth button
                } else {
                    showToast('Please provide both keys.', 'error');
                }
            });
            
            // --- ATTACH ALL OTHER EVENT LISTENERS ---
            searchInput.addEventListener('input', renderAll);
            categoryFilter.addEventListener('change', renderAll);
            typeFilter.addEventListener('change', renderAll);
            addTransactionBtnQuick.addEventListener('click', showTransactionModal);
            syncButton.addEventListener('click', loadAppData);
            changeFileButton.addEventListener('click', changeFile);
            settingsButton.addEventListener('click', showCategoryModal);
            transactionTypeInput.addEventListener('change', toggleCategoryField);
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);
            modalCloseBtn.addEventListener('click', hideTransactionModal);
            modalCancelBtn.addEventListener('click', hideTransactionModal);
            transactionModal.addEventListener('click', (e) => {
                if (e.target === transactionModal) hideTransactionModal();
            });
            categoryForm.addEventListener('submit', handleCategoryFormSubmit);
            categoryModalCloseBtn.addEventListener('click', hideCategoryModal);
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) hideCategoryModal();
            });
        });

        // --- AUTHENTICATION ---
        
        function initializeGisClient() {
            if (!CLIENT_ID) {
                console.warn("GIS Client NOT initialized: Missing CLIENT_ID");
                return;
            }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, // Use variable
                    scope: SCOPES, // Use new scope
                    callback: '', // Callback is set dynamically
                });
            } catch (err) {
                console.error("Error initializing GIS Client: ", err);
                showToast("Invalid Client ID. Please check settings.", 'error');
                localStorage.removeItem(CLIENT_ID_KEY);
                CLIENT_ID = null;
                setupModal.classList.remove('hidden');
            }
        }
        
        async function handleAuthClick() {
            if (!tokenClient) {
                showToast('Google Auth is not ready. Is your Client ID correct?', 'error');
                return;
            }
            showLoader('Authenticating...');

            if (gapi.client.getToken() === null) {
                // Set the callback *before* requesting the token
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        hideLoader();
                        showToast(`Error: ${resp.error}`, 'error');
                        throw (resp);
                    }
                    await initializeApp();
                };
                
                // Request the token
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    tokenClient.requestAccessToken({ prompt: '' });
                }
            } else {
                // Already authenticated
                await initializeApp();
            }
        }

        async function initializeApp() {
            showLoader('Loading Google APIs...');
            try {
                // Load Sheets, Drive, and UserInfo APIs
                await gapi.client.load('https://sheets.googleapis.com/$discovery/rest?version=v4');
                await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
                
                showLoader('Accessing user profile...');
                const profileResponse = await gapi.client.request({
                    'path': 'https://www.googleapis.com/oauth2/v2/userinfo'
                });

                const userName = profileResponse.result.name; 
                userNameEl.textContent = `Hello, ${userName}`;
                userNameEl.classList.remove('hidden');
                authButton.textContent = 'Sign Out';
                authButton.onclick = handleSignOut;
                
                // Check if we have a file ID stored
                if (!sheetFileId) {
                    showLoader('Please select a Google Sheet...');
                    await loadPicker();
                } else {
                    await loadAppData();
                }
            } catch (err) {
                console.error('Error during app initialization:', err);
                let errorMessage = 'Could not load Google APIs.';
                if (err.result && err.result.error) {
                    errorMessage = `Error: ${err.result.error.message} (Code: ${err.result.error.status})`;
                } else if (err.message) {
                    errorMessage = err.message;
                }
                showToast(errorMessage, 'error');
                hideLoader();
            }
        }

        function handleSignOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    sheetFileId = null;
                    // Don't clear API/Client keys, just the file ID
                    localStorage.removeItem(SHEET_FILE_ID_KEY); 
                    mainContent.classList.add('hidden');
                    authButton.textContent = 'Sign In with Google';
                    authButton.onclick = handleAuthClick;
                    userNameEl.classList.add('hidden');
                    showToast('Signed out successfully.');
                });
            }
        }

        // --- GOOGLE PICKER LOGIC ---

        async function loadPicker() {
            if (!window.pickerInited) {
                showToast('Picker API not loaded.', 'error');
                hideLoader();
                return;
            }
            if (!PICKER_API_KEY) {
                showToast('Missing API Key. Please enter it in settings.', 'error');
                hideLoader();
                setupModal.classList.remove('hidden'); // Show setup
                return;
            }
            
            try {
                // First, check if the stored file ID is still valid
                if (sheetFileId) {
                    try {
                        showLoader('Verifying existing sheet...');
                        await gapi.client.sheets.spreadsheets.get({
                            spreadsheetId: sheetFileId
                        });
                        // If no error, load the data
                        await loadAppData();
                        return;
                    } catch (e) {
                        // File not found or permission denied
                        showToast('Previous sheet not found. Please select again.', 'warning');
                        sheetFileId = null;
                        localStorage.removeItem(SHEET_FILE_ID_KEY);
                    }
                }
                
                // If no valid file ID, search for a default file
                showLoader('Searching for finance sheet...');
                const response = await gapi.client.drive.files.list({
                   'q': "mimeType='application/vnd.google-apps-spreadsheet' and name='MyFinanceAppSheet' and trashed=false",
                    'fields': 'files(id, name)'
                });
                
                const files = response.result.files;
                if (files && files.length > 0) {
                    // Found it! Use this file.
                    sheetFileId = files[0].id;
                    localStorage.setItem(SHEET_FILE_ID_KEY, sheetFileId);
                    showToast('Found existing finance sheet.');
                    await loadAppData();
                } else {
                    // No file found, open the picker for the user to select one.
                    showLoader('Please select or create a finance sheet...');
                    createPicker();
                }
            } catch (err) {
                 console.error('Error listing files:', err);
                 showToast('Error finding your sheet. Please try picking it.', 'error');
                 createPicker();
            }
        }

        // --- FIX: SIMPLIFIED PICKER ---
        function createPicker() {
            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            view.setMimeTypes('application/vnd.google-apps-spreadsheet');
            
            const picker = new google.picker.PickerBuilder()
                .addView(view)
                .setTitle('Select your finance sheet')
                .setOAuthToken(gapi.client.getToken().access_token)
                .setDeveloperKey(PICKER_API_KEY)
                .setCallback(pickerCallback) // Use the new callback
                .build();
            
            picker.setVisible(true);
        }
        
        // --- FIX: SIMPLIFIED CALLBACK ---
        async function pickerCallback(data) {
            hideLoader();
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                sheetFileId = doc.id;
                localStorage.setItem(SHEET_FILE_ID_KEY, sheetFileId);
                
                showToast('Selected sheet: ' + doc.name);
                // Check if the sheet is new/empty, if so, initialize it.
                await checkAndInitializeSheet();
            } else if (data.action === google.picker.Action.CANCEL) {
                showToast('Please select a file to continue.', 'error');
                hideLoader();
            }
        }

        async function changeFile() {
            sheetFileId = null;
            localStorage.removeItem(SHEET_FILE_ID_KEY);
            await loadPicker();
        }

        // --- DATA HANDLING (GOOGLE SHEETS API) ---
        
        // --- NEW FUNCTION to check if a picked sheet is empty ---
        async function checkAndInitializeSheet() {
            showLoader('Checking sheet format...');
            try {
                // Try to get sheet data
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: sheetFileId,
                    ranges: [`${SHEET_NAME}!A1:F1`, `${CATEGORY_SHEET_NAME}!A1:A1`],
                });
                
                // If it loads without error, just load the data
                await loadAppData();

            } catch(err) {
                // If it fails (e.g. "Unable to parse range"), it's likely a blank sheet
                if (err.result && err.result.error.message.includes("Unable to parse range")) {
                    showToast('Blank sheet detected. Initializing...', 'warning');
                    await initializeNewSheet();
                } else {
                    // A different error
                    console.error('Error checking sheet:', err);
                    showToast('Could not access sheet.', 'error');
                    hideLoader();
                }
            }
        }

        async function initializeNewSheet() {
            showLoader('Initializing new sheet...');
            try {
                // 1. Rename Sheet1 to Transactions
                const renameRequest = {
                    requests: [{
                        updateSheetProperties: {
                            properties: { sheetId: 0, title: SHEET_NAME },
                            fields: "title"
                        }
                    }]
                };
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: sheetFileId,
                    resource: renameRequest,
                });

                // 2. Set headers for Transactions sheet
                const transactionHeaders = { values: [['ID', 'Date', 'Description', 'Amount', 'Type', 'Category']] };
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetFileId,
                    range: `${SHEET_NAME}!A1:F1`,
                    valueInputOption: 'RAW',
                    resource: transactionHeaders,
                });

                // 3. Create Categories sheet
                const addCategorySheetRequest = { requests: [{ addSheet: { properties: { title: CATEGORY_SHEET_NAME } } }] };
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: sheetFileId,
                    resource: addCategorySheetRequest,
                });

                // 4. Add default categories to Categories sheet
                const categoryData = DEFAULT_CATEGORIES.map(cat => [cat]);
                const categoryBody = { values: categoryData };
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetFileId,
                    range: `${CATEGORY_SHEET_NAME}!A1`,
                    valueInputOption: 'RAW',
                    resource: categoryBody,
                });

                showToast('New sheet initialized.');
                await loadAppData(); // Load the (now empty) data
            } catch (err) {
                console.error('Error initializing sheet:', err);
                showToast('Error initializing sheet.', 'error');
                hideLoader();
            }
        }

        async function loadAppData() {
            showLoader('Loading financial data...');
            if (!sheetFileId) {
                showToast('No Google Sheet file selected.', 'error');
                hideLoader();
                await loadPicker();
                return;
            }

            try {
                // Get both sheets at once
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: sheetFileId,
                    ranges: [`${SHEET_NAME}!A:F`, `${CATEGORY_SHEET_NAME}!A:A`],
                });

                // Parse Transactions
                const transactionValues = response.result.valueRanges[0].values;
                if (transactionValues && transactionValues.length > 1) { // >1 to skip header
                    transactions = transactionValues.slice(1).map(row => ({
                        id: row[0],
                        date: row[1],
                        description: row[2],
                        amount: parseFloat(row[3]),
                        type: row[4],
                        category: row[5],
                    })).filter(t => t.id && t.date && t.amount != null); // Basic validation
                } else {
                    transactions = [];
                }
                
                // Parse Categories
                const categoryValues = response.result.valueRanges[1].values;
                if (categoryValues && categoryValues.length > 0) {
                    categories = categoryValues.map(row => row[0]).filter(cat => cat); // Filter out empty rows
                }
                // If no categories, populate with defaults and save
                if (!categories || categories.length === 0) {
                    categories = [...DEFAULT_CATEGORIES];
                    await saveCategories();
                }

                updateUI();
                syncStatusEl.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                showToast('Data loaded successfully.');
            } catch (err) {
                console.error('Error loading app data:', err);
                if (err.result && (err.result.error.status === 'NOT_FOUND' || err.result.error.status === 'PERMISSION_DENIED')) {
                    showToast('Sheet not found or permission denied. Please select file.', 'error');
                    sheetFileId = null; localStorage.removeItem(SHEET_FILE_ID_KEY);
                    await loadPicker();
                } else if (err.result && err.result.error.message.includes("Unable to parse range")) {
                    // This happens if the sheet exists but the tabs (e.g., 'Categories') are missing
                    showToast('Sheet seems to be missing tabs. Initializing.', 'warning');
                    await initializeNewSheet();
                } else {
                    showToast('Error loading data.', 'error');
                }
            } finally {
                hideLoader();
            }
        }

        async function syncDataToSheet() {
            showLoader('Syncing data to Google Sheet...');
            try {
                // Prepare transaction data
                const transactionData = [
                    ['ID', 'Date', 'Description', 'Amount', 'Type', 'Category'], // Headers
                    ...transactions.map(t => [t.id, t.date, t.description, t.amount, t.type, t.category])
                ];
                // Prepare category data
                const categoryData = categories.map(c => [c]);

                // Clear existing data (but not headers)
                await gapi.client.sheets.spreadsheets.values.batchClear({
                    spreadsheetId: sheetFileId,
                    resource: {
                        ranges: [`${SHEET_NAME}!A2:F`, `${CATEGORY_SHEET_NAME}!A:A`]
                    }
                });

                // Write new data
                const batchUpdateRequest = {
                    valueInputOption: 'RAW',
                    data: [
                        { range: `${SHEET_NAME}!A1:F${transactionData.length}`, values: transactionData },
                        { range: `${CATEGORY_SHEET_NAME}!A1:A${categoryData.length}`, values: categoryData }
                    ]
                };
                
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: sheetFileId,
                    resource: batchUpdateRequest
                });

                syncStatusEl.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
                showToast('Data synced to Google Sheet!');
            } catch (err) {
                console.error('Error syncing data:', err);
                showToast('Error syncing data.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        async function saveCategories() {
            showLoader('Saving categories...');
            try {
                const categoryData = categories.map(c => [c]);
                const body = { values: categoryData };
                
                // Clear all old categories
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: sheetFileId,
                    range: `${CATEGORY_SHEET_NAME}!A:A`,
                });
                
                // Write new categories (if any)
                if (categoryData.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: sheetFileId,
                        range: `${CATEGORY_SHEET_NAME}!A1`,
                        valueInputOption: 'RAW',
                        resource: body,
                    });
                }
                showToast('Categories saved.');
            } catch (err) {
                console.error('Error saving categories:', err);
                showToast('Error saving categories.', 'error');
            } finally {
                hideLoader();
            }
        }

        // --- UI RENDERING ---
        
        function updateUI() {
            renderAll();
            mainContent.classList.remove('hidden');
        }

        function renderAll() {
            const filtered = getFilteredTransactions();
            renderStats();
            renderTransactionTable(filtered);
            renderCategoryFilters(); // Update filters in case categories changed
            renderIncomeExpensePieChart();
            renderBarChart();
        }

        function getFilteredTransactions() {
            const searchTerm = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            const type = typeFilter.value;

            return transactions
                .filter(t => (t.description || '').toLowerCase().includes(searchTerm))
                .filter(t => category === 'All' || t.category === category)
                .filter(t => type === 'All' || t.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(num);
        }

        function renderStats() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = totalIncome - totalExpenses;
            const savingsRate = totalIncome > 0 ? (totalBalance / totalIncome) * 100 : 0;
            
            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            savingsRateEl.textContent = `${savingsRate.toFixed(1)}%`;
            
            // Set colors
            totalBalanceEl.classList.toggle('text-green-400', totalBalance >= 0);
            totalBalanceEl.classList.toggle('text-red-400', totalBalance < 0);
            
            // Trends (simplified for now)
            balanceTrendEl.classList.toggle('text-green-400', totalBalance >= 0);
            balanceTrendEl.classList.toggle('text-red-400', totalBalance < 0);
            balanceTrendEl.textContent = totalBalance >= 0 ? 'Trending positive' : 'Trending negative';
            incomeTrendEl.textContent = 'N/A';
            expenseTrendEl.textContent = 'N/A';
            savingsTrendEl.textContent = 'N/A';
        }

        function renderTransactionTable(filteredTransactions) {
            transactionTableBody.innerHTML = '';
            if (filteredTransactions.length === 0) {
                noTransactionsEl.classList.remove('hidden');
                return;
            }
            noTransactionsEl.classList.add('hidden');

            filteredTransactions.forEach(t => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700 hover:bg-slate-700/50';
                row.innerHTML = `
                    <td class="py-3 px-4">${t.date || ''}</td>
                    <td class="py-3 px-4">${t.description || ''}</td>
                    <td class="py-3 px-4">
                        ${t.category ? `<span class="bg-slate-700 text-slate-300 text-xs font-medium px-2 py-1 rounded-full">${t.category}</span>` : ''}
                    </td>
                    <td class="py-3 px-4 text-right font-medium ${t.type === 'Income' ? 'text-green-400' : 'text-red-400'}">
                        ${t.type === 'Expense' ? '-' : '+'}${formatCurrency(t.amount || 0)}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button class="text-slate-500 hover:text-red-400 transition-colors" data-id="${t.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </td>
                `;
                row.querySelector('button').addEventListener('click', () => deleteTransaction(t.id));
                transactionTableBody.appendChild(row);
            });
        }

        function renderCategoryFilters() {
            categoryFilter.innerHTML = '<option value="All">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }

        function renderIncomeExpensePieChart() {
            const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
            
            if (pieChartInstance) { pieChartInstance.destroy(); }
            
            if (totalIncome === 0 && totalExpenses === 0) {
                pieChartEl.classList.remove('loaded');
                return; // Don't render empty chart
            }
            
            pieChartInstance = new Chart(pieChartEl, {
                type: 'pie',
                data: {
                    labels: ['Total Income', 'Total Expenses'],
                    datasets: [{
                        data: [totalIncome, totalExpenses],
                        backgroundColor: ['rgba(52, 211, 153, 0.7)', 'rgba(248, 113, 113, 0.7)'],
                        borderColor: ['#10b981', '#ef4444'],
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                }
            });
            setTimeout(() => pieChartEl.classList.add('loaded'), 10);
        }

        function renderBarChart() {
            const monthlyData = {};
            transactions.forEach(t => {
                if (!t.date) return;
                const month = t.date.substring(0, 7); // "YYYY-MM"
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expenses: 0 };
                }
                if (t.type === 'Income') {
                    monthlyData[month].income += t.amount;
                } else {
                    monthlyData[month].expenses += t.amount;
                }
            });

            // Get last 6 months
            const labels = [];
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                labels.push(d.toISOString().substring(0, 7)); // "YYYY-MM"
            }

            const incomeData = labels.map(label => monthlyData[label]?.income || 0);
            const expenseData = labels.map(label => monthlyData[label]?.expenses || 0);
            
            // Format labels for display (e.g., "Jan")
            const displayLabels = labels.map(label => {
                const d = new Date(label + '-02'); // Use 2nd day to avoid timezone issues
                return d.toLocaleString('default', { month: 'short' });
            });
            
            if (barChartInstance) { barChartInstance.destroy(); }
            barChartInstance = new Chart(barChartEl, {
                type: 'bar',
                data: {
                    labels: displayLabels,
                    datasets: [
                        { label: 'Income', data: incomeData, backgroundColor: 'rgba(52, 211, 153, 0.7)', borderColor: '#10b981', borderWidth: 1 },
                        { label: 'Expenses', data: expenseData, backgroundColor: 'rgba(248, 113, 113, 0.7)', borderColor: '#ef4444', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                }
            });
            setTimeout(() => barChartEl.classList.add('loaded'), 10);
        }

        // --- TRANSACTION MODAL ---
        
        function showTransactionModal() {
            modalTitle.textContent = 'Add Transaction';
            modalSubmitBtn.textContent = 'Add Transaction';
            transactionForm.reset();
            transactionIdInput.value = '';
            transactionDateInput.value = new Date().toISOString().split('T')[0];
            populateCategoryDropdown();
            toggleCategoryField();
            transactionModal.classList.remove('hidden');
        }
        
        function hideTransactionModal() {
            transactionModal.classList.add('hidden');
        }
        
        async function handleTransactionFormSubmit(e) {
            e.preventDefault();
            const transaction = {
                id: transactionIdInput.value || crypto.randomUUID(),
                date: transactionDateInput.value,
                description: transactionDescriptionInput.value.trim(),
                amount: parseFloat(transactionAmountInput.value),
                type: transactionTypeInput.value,
                category: transactionTypeInput.value === 'Expense' ? transactionCategoryInput.value : ''
            };
            
            if (!transaction.description) {
                showToast('Description cannot be empty.', 'error');
                return;
            }
            if (isNaN(transaction.amount) || transaction.amount <= 0) {
                showToast('Please enter a valid amount.', 'error');
                return;
            }

            if (transactionIdInput.value) {
                // Edit existing
                const index = transactions.findIndex(t => t.id === transaction.id);
                if (index !== -1) {
                    transactions[index] = transaction;
                }
            } else {
                // Add new
                transactions.push(transaction);
            }
            
            updateUI(); // Show change immediately
            await syncDataToSheet(); // Save to cloud
            hideTransactionModal();
            showToast(`Transaction ${transactionIdInput.value ? 'updated' : 'added'} successfully.`);
        }

        async function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                updateUI();
                await syncDataToSheet();
                showToast('Transaction deleted.', 'error');
            }
        }

        function toggleCategoryField() {
            if (transactionTypeInput.value === 'Expense') {
                categoryGroup.classList.remove('hidden');
                transactionCategoryInput.required = true;
            } else {
                categoryGroup.classList.add('hidden');
                transactionCategoryInput.required = false;
            }
        }

        function populateCategoryDropdown() {
            transactionCategoryInput.innerHTML = '';
            const expenseCategories = categories.filter(cat => {
                const lowerCat = cat.toLowerCase();
                return lowerCat !== 'salary' && lowerCat !== 'freelance'; // Example of filtering
            });
            
            if (expenseCategories.length === 0) {
                 const option = document.createElement('option');
                 option.value = "Other";
                 option.textContent = "Other";
                 transactionCategoryInput.appendChild(option);
            } else {
                expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    transactionCategoryInput.appendChild(option);
                });
            }
        }

        // --- CATEGORY MODAL ---
        
        function showCategoryModal() {
            renderCategoryList();
            categoryModal.classList.remove('hidden');
        }
        
        function hideCategoryModal() {
            categoryModal.classList.add('hidden');
        }
        
        function renderCategoryList() {
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = `<p class="text-slate-500 text-center">No categories found. Add one above.</p>`;
                return;
            }

            categories.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-lg';
                item.innerHTML = `
                    <span class="text-white">${cat}</span>
                    <button class="text-slate-400 hover:text-red-400" data-category="${cat}">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>`;
                item.querySelector('button').addEventListener('click', () => deleteCategory(cat));
                categoryListEl.appendChild(item);
            });
        }
        
        async function handleCategoryFormSubmit(e) {
            e.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (newCategory && !categories.find(c => c.toLowerCase() === newCategory.toLowerCase())) {
                categories.push(newCategory);
                renderCategoryList();
                populateCategoryDropdown();
                renderCategoryFilters();
                await saveCategories();
                showToast('Category added.');
                newCategoryNameInput.value = '';
            } else if (categories.includes(newCategory)) {
                showToast('Category already exists.', 'error');
            }
        }
        
        async function deleteCategory(category) {
            if (confirm(`Are you sure you want to delete the category "${category}"? This will not affect existing transactions.`)) {
                categories = categories.filter(c => c !== category);
                renderCategoryList();
                populateCategoryDropdown();
                renderCategoryFilters();
                await saveCategories();
                showToast('Category deleted.', 'error');
            }
        }

        // --- HELPERS (Loader, Toast) ---

        function showLoader(message) {
            loadingStatus.textContent = message;
            globalLoader.classList.remove('hidden');
            globalLoader.classList.add('flex');
        }

        function hideLoader() {
            globalLoader.classList.add('hidden');
            globalLoader.classList.remove('flex');
        }

        let toastTimer;
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            // Reset classes
            toast.classList.remove('bg-green-500', 'bg-red-500', 'opacity-0');
            toast.style.transform = 'translateX(110%)';
            
            if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('hidden');
            
            // Force browser repaint
            void toast.offsetWidth; 
            
            // Animate in
            toast.style.transform = 'translateX(0)';
            toast.classList.add('opacity-100');


            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.style.transform = 'translateX(110%)';
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');

                // Hide after transition
                toast.addEventListener('transitionend', () => {
                    toast.classList.add('hidden');
                }, { once: true });
            }, 3000);
        }
    </script>
    
    <!-- 
      ===============================================================
      Google API scripts
      ===============================================================
    -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>
