<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Manager</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. SheetJS (xlsx) library for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- 3. Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- App Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* For the donut chart */
        #donut-chart {
            background: conic-gradient(
                from 0deg,
                #3b82f6 0% 12%,
                #10b981 12% 92%,
                #a855f7 92% 94%,
                #f59e0b 94% 99%,
                #ef4444 99% 100%
            );
            border-radius: 50%;
            width: 200px;
            height: 200px;
            margin: 1.5rem auto;
            position: relative;
        }
        #donut-chart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            background: #1f2937; /* bg-neutral-800 */
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-neutral-900 text-neutral-200">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-full">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 p-4">
            <div class="flex items-center space-x-3">
                <!-- Logo -->
                <svg class="w-8 h-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.097V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.75A.75.75 0 0 1 3 4.5h.75m12 0v.75A.75.75 0 0 0 15 6h.75m0 0v-.75A.75.75 0 0 0 15 4.5h-.75M5.25 12v.75A.75.75 0 0 1 4.5 13.5h-.75m0 0v-.75A.75.75 0 0 1 4.5 12h.75m12 0v.75A.75.75 0 0 0 16.5 13.5h.75m0 0v-.75A.75.75 0 0 0 16.5 12h-.75m-6 0v.75A.75.75 0 0 1 9 13.5h-.75m0 0v-.75A.75.75 0 0 1 9 12h.75M3 18.75V15a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 15v3.75m-18 0h18" />
                </svg>
                <h1 class="text-2xl font-bold text-neutral-100">Personal Finance Manager</h1>
            </div>
            <div id="auth-container" class="flex items-center space-x-4">
                <button id="authorize-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                    Sign In with Google
                </button>
                <button id="signout-button" class="hidden bg-neutral-700 hover:bg-neutral-600 text-neutral-200 font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                    Sign Out
                </button>
                <!-- Profile Icon -->
                <div id="user-profile" class="hidden w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-white">
                    JD
                </div>
            </div>
        </header>

        <!-- Loading / Initial State -->
        <div id="loading-state" class="text-center p-10 bg-neutral-800 rounded-lg shadow-xl">
            <p class="text-xl text-neutral-400">Please sign in to load your financial data from Google Drive.</p>
        </div>

        <!-- Main Content (Hidden by default) -->
        <main id="main-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Column -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Dashboard Summary -->
                <section id="dashboard" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <!-- Current Balance -->
                    <div class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-lg font-semibold text-neutral-400">Current Balance</h2>
                            <span class="p-2 bg-blue-500/20 text-blue-400 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            </span>
                        </div>
                        <p id="current-balance" class="text-3xl font-bold text-neutral-100">$0.00</p>
                        <p id="balance-trend" class="text-sm text-neutral-500 mt-1 flex items-center">
                            <!-- Trend data here -->
                        </p>
                    </div>
                     <!-- Total Income -->
                    <div class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-lg font-semibold text-neutral-400">Total Income</h2>
                            <span class="p-2 bg-green-500/20 text-green-400 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                            </span>
                        </div>
                        <p id="total-income" class="text-3xl font-bold text-green-400">$0.00</p>
                        <p id="income-trend" class="text-sm text-neutral-500 mt-1 flex items-center">
                            <!-- Trend data here -->
                        </p>
                    </div>
                    <!-- Total Expenses -->
                    <div class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-lg font-semibold text-neutral-400">Total Expenses</h2>
                            <span class="p-2 bg-red-500/20 text-red-400 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>
                            </span>
                        </div>
                        <p id="total-expense" class="text-3xl font-bold text-red-400">$0.00</p>
                        <p id="expense-trend" class="text-sm text-neutral-500 mt-1 flex items-center">
                            <!-- Trend data here -->
                        </p>
                    </div>
                    <!-- Savings Rate -->
                    <div class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-lg font-semibold text-neutral-400">Savings Rate</h2>
                             <span class="p-2 bg-indigo-500/20 text-indigo-400 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v8m0 0l3-3m-3 3L9 8m-5 5h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293h3.172a1 1 0 00.707-.293l2.414-2.414a1 1 0 01.707-.293H20" /></svg>
                            </span>
                        </div>
                        <p id="savings-rate" class="text-3xl font-bold text-indigo-400">0.0%</p>
                        <p id="savings-trend" class="text-sm text-neutral-500 mt-1 flex items-center">
                            <!-- Trend data here -->
                        </p>
                    </div>
                </section>

                <!-- Charts Row -->
                <section id="charts-row" class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <!-- Spending by Category -->
                    <div class="md:col-span-2 bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-xl font-bold mb-4 text-neutral-100">Spending by Category</h2>
                        <div id="donut-chart-container" class="flex flex-col items-center">
                            <div id="donut-chart"></div>
                            <div id="donut-legend" class="w-full mt-4 space-y-2">
                                <!-- Legend items go here -->
                            </div>
                        </div>
                    </div>

                    <!-- Income vs Expenses -->
                    <div class="md:col-span-3 bg-neutral-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-xl font-bold mb-6 text-neutral-100">Income vs Expenses</h2>
                        <div id="bar-chart-container" class="w-full h-80 flex justify-around items-end space-x-2 md:space-x-4 px-2">
                            <!-- Bar chart will be generated here -->
                        </div>
                        <div class="flex justify-center space-x-4 mt-4">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                <span class="text-sm text-neutral-400">Income</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                <span class="text-sm text-neutral-400">Expenses</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transaction History -->
                <section id="transaction-history" class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-neutral-100 mb-4 md:mb-0">Transaction History</h2>
                        <div class="flex w-full md:w-auto space-x-2">
                            <input type="search" id="search-tx" placeholder="Search transactions..." class="w-full md:w-auto px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="filter-tx-type" class="px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-neutral-700">
                            <thead class="">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral-400 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-neutral-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-table-body" class="bg-neutral-800 divide-y divide-neutral-700">
                                <!-- Transactions will be populated here -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500 text-center">No transactions found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Right Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <section id="quick-actions" class="bg-neutral-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-xl font-bold mb-4 text-neutral-100">Quick Actions</h2>
                    <div class="space-y-3">
                        <button id="open-modal-button" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Add New Transaction
                        </button>
                        <button id="sync-drive-button" class="w-full flex items-center bg-neutral-700 hover:bg-neutral-600 text-neutral-200 font-semibold py-3 px-4 rounded-lg transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.59 13.41a.75.75 0 010 1.06l-5.3 5.3a.75.75 0 01-1.06 0l-5.3-5.3a.75.75 0 011.06-1.06l4.22 4.22V6.24a.75.75 0 111.5 0v11.39l4.22-4.22a.75.75 0 011.06 0zM4.75 3.5a.75.75 0 010-1.06l5.3-5.3a.75.75 0 011.06 0l5.3 5.3a.75.75 0 01-1.06 1.06L11.19-.78v11.39a.75.75 0 11-1.5 0V-.78L5.81 3.5a.75.75 0 01-1.06 0z" clip-rule="evenodd" transform="rotate(90 10 10)" /></svg>
                            Sync with Drive
                        </button>
                    </div>
                </section>
            </div>

        </main>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-neutral-800 w-full max-w-md p-6 rounded-lg shadow-xl transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-neutral-100">Add Transaction</h2>
                <button type="button" id="close-modal-button" class="text-neutral-500 hover:text-neutral-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-sm text-neutral-400 mb-6">Record a new income or expense transaction</p>
            <form id="transaction-form">
                <div class="flex space-x-4 mb-4">
                    <div class="w-1/2">
                        <label for="tx-date" class="block text-sm font-medium text-neutral-300 mb-1">Date</label>
                        <input type="date" id="tx-date" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="w-1/2">
                        <label for="tx-type" class="block text-sm font-medium text-neutral-300 mb-1">Type</label>
                        <select id="tx-type" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="tx-amount" class="block text-sm font-medium text-neutral-300 mb-1">Amount ($)</label>
                    <input type="number" id="tx-amount" step="0.01" min="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="tx-category" class="block text-sm font-medium text-neutral-300 mb-1">Category</label>
                    <select id="tx-category" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <!-- Categories will be populated by JS -->
                        <option value="">Select category</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="tx-description" class="block text-sm font-medium text-neutral-300 mb-1">Description</label>
                    <textarea id="tx-description" placeholder="Enter transaction details..." rows="3" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-modal-button" class="bg-neutral-600 hover:bg-neutral-500 text-neutral-200 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Setup Modal (for Client ID) -->
    <div id="setup-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="modal-content bg-neutral-800 w-full max-w-lg p-6 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-4 text-neutral-100">One-Time Setup</h2>
            <p class="mb-4 text-neutral-300">To connect to Google Drive, this app needs your Google OAuth Client ID.</p>
            <p class="mb-4 text-sm text-neutral-400">
                You can get this by:
                <ol class="list-decimal list-inside text-sm text-neutral-400 space-y-1 pl-4">
                    <li>Going to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a>.</li>
                    <li>Creating a new project.</li>
                    <li>Enabling the "Google Drive API".</li>
                    <li>Going to "APIs & Services" > "Credentials".</li>
                    <li>Creating an "OAuth client ID" for a "Web application".</li>
                    <li>Adding your GitHub Pages URL (e.g., `https://username.github.io`) to "Authorized JavaScript origins".</li>
                    <li>Copying the generated Client ID.</li>
                </ol>
            </p>
            <div class="mb-4">
                <label for="client-id-input" class="block text-sm font-medium text-neutral-300 mb-1">Google OAuth Client ID</label>
                <input type="text" id="client-id-input" placeholder="xxxxx.apps.googleusercontent.com" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-lg text-neutral-200 placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end">
                <button id="save-client-id-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Save and Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 bg-green-600 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message">Success!</p>
    </div>


    <!-- Main Application Script -->
    <script type="module">
        // === CONFIGURATION ===
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FINANCE_FILE_NAME = 'MyFinanceApp.xlsx';
        const TRANSACTIONS_SHEET = 'Transactions';
        const CATEGORIES_SHEET = 'Categories';
        const CATEGORY_COLORS = ['#3b82f6', '#10b981', '#a855f7', '#f59e0b', '#ef4444', '#6b7280', '#ec4899', '#84cc16'];
        
        // === APP STATE ===
        let gapiClient;
        let tokenClient;
        let googleClientId = localStorage.getItem('googleClientId');
        let transactions = []; // Our local database
        let categories = ['Food', 'Transport', 'Utilities', 'Entertainment', 'Salary', 'Other'];
        let financeFileId = null; // Google Drive File ID
        let isSaving = false; // Debounce saving
        let searchFilter = '';
        let typeFilter = 'all';

        // === DOM ELEMENTS ===
        const setupModal = document.getElementById('setup-modal');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');

        const authorizeButton = document.getElementById('authorize-button');
        const signoutButton = document.getElementById('signout-button');
        const userProfile = document.getElementById('user-profile');
        const loadingState = document.getElementById('loading-state');
        const mainContent = document.getElementById('main-content');
        
        const openModalButton = document.getElementById('open-modal-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const cancelModalButton = document.getElementById('cancel-modal-button'); // New cancel button
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const syncDriveButton = document.getElementById('sync-drive-button');
        
        const txType = document.getElementById('tx-type');
        const txDate = document.getElementById('tx-date');
        const txDescription = document.getElementById('tx-description');
        const txCategory = document.getElementById('tx-category');
        const txAmount = document.getElementById('tx-amount');
        
        // Dashboard Cards
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const currentBalanceEl = document.getElementById('current-balance');
        const savingsRateEl = document.getElementById('savings-rate');
        const incomeTrendEl = document.getElementById('income-trend');
        const expenseTrendEl = document.getElementById('expense-trend');
        const balanceTrendEl = document.getElementById('balance-trend');
        const savingsTrendEl = document.getElementById('savings-trend');

        // Charts
        const donutChart = document.getElementById('donut-chart');
        const donutLegend = document.getElementById('donut-legend');
        const barChartContainer = document.getElementById('bar-chart-container');

        // Transaction History
        const transactionTableBody = document.getElementById('transaction-table-body');
        const searchTxInput = document.getElementById('search-tx');
        const filterTxTypeSelect = document.getElementById('filter-tx-type');
        
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // === INITIALIZATION ===
        window.onload = () => {
            // 1. Check for Client ID
            if (!googleClientId) {
                showSetupModal();
            } else {
                hideSetupModal();
                // 2. Load Google API scripts
                loadGapiScript();
                loadGisScript();
            }

            // Init event listeners for filters
            searchTxInput.addEventListener('input', (e) => {
                searchFilter = e.target.value.toLowerCase();
                renderTransactionTable();
            });
            filterTxTypeSelect.addEventListener('change', (e) => {
                typeFilter = e.target.value;
                renderTransactionTable();
            });
            // Delegated listener for delete buttons
            transactionTableBody.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-tx-button');
                if (deleteButton) {
                    const id = deleteButton.dataset.txId;
                    handleDeleteTransaction(id);
                }
            });
            syncDriveButton.addEventListener('click', () => {
                saveFileToDrive();
            });
        };

        function showSetupModal() {
            clientIdInput.value = '';
            setupModal.classList.remove('hidden');
        }

        function hideSetupModal() {
            setupModal.classList.add('hidden');
        }

        saveClientIdButton.addEventListener('click', () => {
            const id = clientIdInput.value.trim();
            if (id) {
                googleClientId = id;
                localStorage.setItem('googleClientId', id);
                hideSetupModal();
                loadGapiScript();
                loadGisScript();
            } else {
                showToast('Please enter a valid Client ID.', 'error');
            }
        });

        // === GOOGLE AUTH & API ===

        /**
         * Load GAPI (Google API Client Library)
         */
        function loadGapiScript() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => gapi.load('client', initializeGapiClient);
            document.body.appendChild(script);
        }

        /**
         * Initialize GAPI client
         */
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiClient = gapi.client;
                authorizeButton.disabled = false;
            } catch (error) {
                console.error('Error initializing GAPI client', error);
                showToast('Error initializing Google API', 'error');
            }
        }

        /**
         * Load GIS (Google Identity Services)
         */
        function loadGisScript() {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = initializeGisClient;
            document.body.appendChild(script);
        }

        /**
         * Initialize GIS client
         */
        function initializeGisClient() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: googleClientId,
                    scope: SCOPES,
                    callback: tokenCallback, // Callback function after token received
                });
            } catch (error) {
                console.error('Error initializing GIS client', error);
                if (error.details?.includes('invalid client_id')) {
                    showToast('Invalid Google Client ID. Please re-enter.', 'error');
                    localStorage.removeItem('googleClientId');
                    showSetupModal();
                }
            }
        }

        /**
         * Callback after user grants permission
         */
        async function tokenCallback(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                gapi.client.setToken(tokenResponse);
                updateUiForAuth();
                await loadAppdata();
            }
        }

        // --- Auth Button Handlers ---
        authorizeButton.addEventListener('click', () => {
            if (!gapiClient) {
                showToast('Google API is not loaded yet.', 'error');
                return;
            }
            if (!tokenClient) {
                 showToast('Google Auth is not loaded yet.', 'error');
                return;
            }
            
            if (gapi.client.getToken() === null) {
                // Prompt user to select an account
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                // User is already signed in, just request token
                tokenClient.requestAccessToken({ prompt: '' });
            }
        });

        signoutButton.addEventListener('click', () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    updateUiForSignOut();
                });
            }
        });

        // --- Auth UI Updates ---
        function updateUiForAuth() {
            authorizeButton.classList.add('hidden');
            signoutButton.classList.remove('hidden');
            userProfile.classList.remove('hidden');
            loadingState.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }
        
        function updateUiForSignOut() {
            authorizeButton.classList.remove('hidden');
            signoutButton.classList.add('hidden');
            userProfile.classList.add('hidden');
            loadingState.classList.remove('hidden');
            mainContent.classList.add('hidden');
            transactions = [];
            financeFileId = null;
            renderAll();
        }

        // === GOOGLE DRIVE FILE HANDLING ===

        /**
         * Main function to load app data from Drive
         */
        async function loadAppdata() {
            showToast('Loading data from Google Drive...', 'loading');
            try {
                // 1. Find the file
                const file = await findFinanceFile();
                
                if (file) {
                    // 2. File exists, download and parse it
                    financeFileId = file.id;
                    const fileContent = await downloadFile(financeFileId);
                    parseExcelFile(fileContent);
                    showToast('Data loaded successfully!', 'success');
                } else {
                    // 3. File doesn't exist, create it
                    financeFileId = await createFinanceFile();
                    showToast('New finance file created in your Google Drive.', 'success');
                }
                
                // 4. Render the UI
                renderAll();

            } catch (error) {
                console.error('Error loading app data:', error);
                showToast(`Error: ${error.message}`, 'error');
                updateUiForSignOut(); // Sign out on critical error
            }
        }

        /**
         * Search for FINANCE_FILE_NAME in user's Drive
         */
        async function findFinanceFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FINANCE_FILE_NAME}' and mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' and 'root' in parents and trashed=false`,
                    fields: 'files(id, name)',
                });
                return response.result.files.length > 0 ? response.result.files[0] : null;
            } catch (error) {
                console.error('Error finding file:', error);
                throw new Error('Could not search for finance file.');
            }
        }

        /**
         * Download the Excel file content
         */
        async function downloadFile(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media',
                });
                // The result is an ArrayBuffer, but GAPI client might return it as an object
                // If response.body is a string, we need to convert it.
                // But for 'alt: media', it should be ArrayBuffer or Blob
                if (response.result) {
                     return response.result;
                }
                // Fallback for different response types
                if (response.body) {
                    const reader = new Response(response.body).arrayBuffer();
                    return await reader;
                }
                throw new Error('Could not read file content from response.');

            } catch (error) {
                console.error('Error downloading file:', error);
                // GAPI often returns object with 'body' (string) on error, or 'result' (object)
                if (error.result && error.result.error) {
                    throw new Error(`Could not download finance file: ${error.result.error.message}`);
                }
                throw new Error('Could not download finance file.');
            }
        }
        
        /**
         * Create a new, empty Excel file
         */
        async function createFinanceFile() {
             try {
                const fileMetadata = {
                    name: FINANCE_FILE_NAME,
                    mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    parents: ['root'],
                };
                
                // Create the empty Excel data
                const excelData = generateExcelData(); // This generates an ArrayBuffer
                
                const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // Use multipart upload to create the file with content
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', blob);

                const response = await gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    body: form,
                });

                return response.result.id;
            } catch (error)
            {
                console.error('Error creating file:', error);
                throw new Error('Could not create new finance file.');
            }
        }
        
        /**
         * Upload and overwrite the existing Excel file
         */
        async function saveFileToDrive() {
            if (isSaving) return; // Prevent multiple saves
            if (!financeFileId) {
                console.error('No file ID to save to.');
                return;
            }
            
            isSaving = true;
            showToast('Saving to Google Drive...', 'loading');
            
            try {
                // 1. Generate new Excel data from `transactions` array
                const excelData = generateExcelData(); // ArrayBuffer
                
                // 2. Upload
                const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                const response = await gapi.client.request({
                    path: `/upload/drive/v3/files/${financeFileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: blob,
                });
                
                showToast('Data saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving file:', error);
                showToast('Error saving file. Changes may be lost.', 'error');
            } finally {
                isSaving = false;
            }
        }


        // === EXCEL FILE HANDLING (SheetJS) ===

        /**
         * Parse the raw Excel (ArrayBuffer) data into app state
         */
        function parseExcelFile(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Parse Transactions
                if (workbook.SheetNames.includes(TRANSACTIONS_SHEET)) {
                    const txSheet = workbook.Sheets[TRANSACTIONS_SHEET];
                    // Convert to JSON, handling dates
                    const jsonData = XLSX.utils.sheet_to_json(txSheet, { cellDates: true });
                    
                    transactions = jsonData.map((row, index) => ({
                        id: index, // Add a simple ID
                        date: row.Date ? new Date(row.Date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0], // Standardize date format
                        description: row.Description || 'No Description',
                        category: row.Category || 'Other',
                        amount: parseFloat(row.Amount) || 0,
                        type: row.Type || 'expense'
                    }));
                } else {
                    transactions = [];
                }
                
                // Parse Categories
                if (workbook.SheetNames.includes(CATEGORIES_SHEET)) {
                    const catSheet = workbook.Sheets[CATEGORIES_SHEET];
                    const jsonData = XLSX.utils.sheet_to_json(catSheet, { header: 1 });
                    // Assumes categories are in the first column
                    const parsedCategories = jsonData.map(row => row[0]).filter(Boolean);
                    if (parsedCategories.length > 0) {
                        categories = parsedCategories;
                    }
                }
                
                console.log('Parsed transactions:', transactions);
                
            } catch (error) {
                console.error('Error parsing Excel file:', error);
                showToast('Could not read Excel file. It might be corrupted.', 'error');
                transactions = []; // Reset state
            }
        }
        
        /**
         * Generate an ArrayBuffer of the Excel file from app state
         */
        function generateExcelData() {
            // 1. Create new Workbook
            const wb = XLSX.utils.book_new();
            
            // 2. Create Transactions Sheet
            // Prepare data with correct headers
            const txData = transactions.map(tx => ({
                'Date': new Date(tx.date),
                'Description': tx.description,
                'Category': tx.category,
                'Amount': tx.amount,
                'Type': tx.type
            }));
            const ws_tx = XLSX.utils.json_to_sheet(txData);
            // Format date column
            ws_tx['!cols'] = [{ wch: 10 }]; // Set date column width
            XLSX.utils.book_append_sheet(wb, ws_tx, TRANSACTIONS_SHEET);
            
            // 3. Create Categories Sheet
            const catData = categories.map(cat => [cat]); // Array of arrays
            const ws_cat = XLSX.utils.aoa_to_sheet(catData);
            ws_cat['!cols'] = [{ wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws_cat, CATEGORIES_SHEET);

            // 4. Write workbook to ArrayBuffer
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            return wbout;
        }


        // === APPLICATION LOGIC & UI RENDERING ===

        /**
         * Re-render all UI components from the `transactions` state
         */
        function renderAll() {
            try {
                // Ensure transactions are sorted before rendering
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                // Re-assign simple IDs after sorting or deletion
                transactions.forEach((tx, index) => tx.id = index);

                renderDashboard();
                renderTransactionTable();
                renderCategoryChart();
                renderIncomeExpenseChart();
            } catch (e) {
                console.error("Error rendering UI:", e);
                showToast('Failed to update UI', 'error');
            }
        }

        /**
         * Get trend icon and color based on percentage change
         */
        function getTrendHtml(percent) {
            if (percent > 0) {
                return `<span class="flex items-center text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                    ${percent.toFixed(1)}% vs last month
                </span>`;
            } else if (percent < 0) {
                 return `<span class="flex items-center text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1.707-7.293l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L9 10.586V7a1 1 0 112 0v3.586l1.293-1.293a1 1 0 111.414 1.414z" clip-rule="evenodd" /></svg>
                    ${Math.abs(percent).toFixed(1)}% vs last month
                </span>`;
            } else {
                return `<span class="text-neutral-500">No change vs last month</span>`;
            }
        }

        /**
         * Calculate percentage change
         */
        function getPercentChange(current, previous) {
            if (previous === 0) {
                return current > 0 ? 100.0 : 0.0; // Avoid division by zero
            }
            return ((current - previous) / previous) * 100;
        }

        /**
         * Get totals for a given date range
         */
        function getTotals(txs, daysAgoStart, daysAgoEnd) {
            const now = new Date();
            const start = new Date(now.getTime() - daysAgoStart * 24 * 60 * 60 * 1000);
            const end = new Date(now.getTime() - daysAgoEnd * 24 * 60 * 60 * 1000);
            
            let income = 0;
            let expense = 0;
            
            for (const t of txs) {
                const txDate = new Date(t.date);
                if (txDate >= end && txDate < start) {
                    if (t.type === 'income') income += t.amount;
                    if (t.type === 'expense') expense += t.amount;
                }
            }
            return { income, expense };
        }
        
        /**
         * Update dashboard summary
         */
        function renderDashboard() {
            // Current period (last 30 days)
            const current = getTotals(transactions, 0, 30);
            // Previous period (31-60 days ago)
            const previous = getTotals(transactions, 30, 60);

            const balance = current.income - current.expense;
            const prevBalance = previous.income - previous.expense;
            
            const savingsRate = current.income > 0 ? ((current.income - current.expense) / current.income) * 100 : 0;
            const prevSavingsRate = previous.income > 0 ? ((previous.income - previous.expense) / previous.income) * 100 : 0;
            
            totalIncomeEl.textContent = formatCurrency(current.income);
            totalExpenseEl.textContent = formatCurrency(current.expense);
            currentBalanceEl.textContent = formatCurrency(balance);
            savingsRateEl.textContent = `${savingsRate.toFixed(1)}%`;
            
            // Render trends
            incomeTrendEl.innerHTML = getTrendHtml(getPercentChange(current.income, previous.income));
            expenseTrendEl.innerHTML = getTrendHtml(getPercentChange(current.expense, previous.expense) * -1); // Invert trend for expenses
            balanceTrendEl.innerHTML = getTrendHtml(getPercentChange(balance, prevBalance));
            savingsTrendEl.innerHTML = getTrendHtml(getPercentChange(savingsRate, prevSavingsRate));
        }

        /**
         * Update transaction history table
         */
        function renderTransactionTable() {
            // Apply filters
            const filteredTx = transactions.filter(tx => {
                const matchesSearch = tx.description.toLowerCase().includes(searchFilter) || 
                                    tx.category.toLowerCase().includes(searchFilter);
                const matchesType = typeFilter === 'all' || tx.type === typeFilter;
                return matchesSearch && matchesType;
            });
            
            if (filteredTx.length === 0) {
                transactionTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500 text-center">No transactions match your filters.</td></tr>`;
                return;
            }
            
            transactionTableBody.innerHTML = filteredTx.map(tx => {
                const isExpense = tx.type === 'expense';
                const amountColor = isExpense ? 'text-red-400' : 'text-green-400';
                const amountSign = isExpense ? '-' : '+';
                
                return `
                    <tr class="hover:bg-neutral-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-200">${tx.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-200">${tx.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-400">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-500/20 text-blue-300">
                                ${tx.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${amountColor}">
                            ${amountSign}${formatCurrency(tx.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right">
                            <button class="delete-tx-button text-neutral-500 hover:text-red-400" data-tx-id="${tx.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Update expense category donut chart
         */
        function renderCategoryChart() {
            const expenseData = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const categories = Object.keys(expenseData);
            const amounts = Object.values(expenseData);
            const totalExpenses = amounts.reduce((sum, a) => sum + a, 0);

            if (totalExpenses === 0) {
                donutChart.style.background = '#404040'; // neutral-700
                donutLegend.innerHTML = `<p class="text-neutral-500 text-center">No expense data to display.</p>`;
                return;
            }

            // Generate conic-gradient string
            let gradientString = 'conic-gradient(from 0deg, ';
            let legendHtml = '';
            let cumulativePercent = 0;

            categories.forEach((category, index) => {
                const amount = amounts[index];
                const percentage = (amount / totalExpenses) * 100;
                const color = CATEGORY_COLORS[index % CATEGORY_COLORS.length];
                
                gradientString += `${color} ${cumulativePercent}% ${cumulativePercent + percentage}%, `;
                
                legendHtml += `
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></span>
                            <span class="text-neutral-300">${category}</span>
                        </div>
                        <span class="font-medium text-neutral-400">${percentage.toFixed(1)}%</span>
                    </div>
                `;
                
                cumulativePercent += percentage;
            });

            // Remove trailing comma and space
            donutChart.style.background = gradientString.slice(0, -2) + ')';
            donutLegend.innerHTML = legendHtml;
        }

        /**
         * Update Income vs Expense Bar Chart
         */
        function renderIncomeExpenseChart() {
            const months = 6; // Show last 6 months
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const monthlyData = [];
            const today = new Date();

            for (let i = months - 1; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const month = date.getMonth();
                const year = date.getFullYear();
                
                monthlyData.push({
                    month: monthNames[month],
                    year: year,
                    income: 0,
                    expense: 0
                });
            }

            // Populate data
            for (const t of transactions) {
                const txDate = new Date(t.date);
                const month = txDate.getMonth();
                const year = txDate.getFullYear();
                
                const dataPoint = monthlyData.find(m => m.month === monthNames[month] && m.year === year);
                if (dataPoint) {
                    if (t.type === 'income') dataPoint.income += t.amount;
                    if (t.type === 'expense') dataPoint.expense += t.amount;
                }
            }
            
            // Find max value for scaling
            const maxIncome = Math.max(...monthlyData.map(m => m.income));
            const maxExpense = Math.max(...monthlyData.map(m => m.expense));
            const maxVal = Math.max(maxIncome, maxExpense, 1); // Avoid division by zero
            
            barChartContainer.innerHTML = monthlyData.map(m => {
                const incomeHeight = (m.income / maxVal) * 100;
                const expenseHeight = (m.expense / maxVal) * 100;

                return `
                    <div class="flex flex-col h-full w-full items-center justify-end">
                        <div class="flex items-end w-full h-full justify-center space-x-1">
                            <div class="w-full bg-green-500 rounded-t-sm" style="height: ${incomeHeight}%" title="Income: ${formatCurrency(m.income)}"></div>
                            <div class="w-full bg-red-500 rounded-t-sm" style="height: ${expenseHeight}%" title="Expense: ${formatCurrency(m.expense)}"></div>
                        </div>
                        <span class="text-xs text-neutral-400 mt-2">${m.month}</span>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * Handle new transaction form submission
         */
        async function handleAddTransaction(e) {
            e.preventDefault();
            
            const newTransaction = {
                id: transactions.length, // Simple temporary ID
                date: txDate.value,
                description: txDescription.value.trim() || 'No Description', // Handle empty description
                category: txCategory.value.trim(),
                amount: parseFloat(txAmount.value),
                type: txType.value
            };
            
            // Add to local state
            transactions.push(newTransaction);
            
            // Update categories list - REMOVED per new design. Categories are managed in the Excel file.
            // if (!categories.includes(newTransaction.category)) {
            //     categories.push(newTransaction.category);
            // }
            
            // Re-render UI
            renderAll();
            
            // Close modal
            hideTransactionModal();
            
            // Save to Google Drive (async)
            await saveFileToDrive();
        }
        
        /**
         * Handle delete transaction
         */
        async function handleDeleteTransaction(id) {
            const index = transactions.findIndex(tx => tx.id == id);
            if (index > -1) {
                // Remove from local state
                transactions.splice(index, 1);
                
                // Re-render UI
                renderAll();
                
                // Save to Google Drive (async)
                await saveFileToDrive();
            }
        }
        
        
        // === MODAL HANDLING ===
        function showTransactionModal() {
            transactionForm.reset();
            txDate.value = new Date().toISOString().split('T')[0]; // Set default date
            
            // Populate category dropdown
            txCategory.innerHTML = '<option value="">Select category</option>'; // Clear existing
            const relevantCategories = categories.filter(c => c.toLowerCase() !== 'salary'); // Example filter
            
            relevantCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                txCategory.appendChild(option);
            });

            transactionModal.classList.remove('hidden');
            setTimeout(() => {
                transactionModal.classList.remove('opacity-0');
                transactionModal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        }

        function hideTransactionModal() {
            transactionModal.classList.add('opacity-0');
            transactionModal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => {
                transactionModal.classList.add('hidden');
            }, 250);
        }
        
        openModalButton.addEventListener('click', showTransactionModal);
        closeModalButton.addEventListener('click', hideTransactionModal);
        cancelModalButton.addEventListener('click', hideTransactionModal); // Add listener for new cancel button
        transactionForm.addEventListener('submit', handleAddTransaction);
        
        
        // === UTILITIES ===
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            clearTimeout(toastTimeout);
            
            toastMessage.textContent = message;
            
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else if (type === 'loading') {
                toast.classList.add('bg-blue-600');
            } else {
                toast.classList.add('bg-green-600');
            }
            
            toast.classList.remove('opacity-0');
            
            if (type !== 'loading') {
                toastTimeout = setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 3000);
            }
        }
        
        // Close loading toast when a new one appears
        const originalShowToast = showToast;
        showToast = (message, type) => {
            if (type !== 'loading' && toast.classList.contains('bg-blue-600')) {
                toast.classList.add('opacity-0'); // Hide loading toast
            }
            setTimeout(() => originalShowToast(message, type), 50); // Show new toast
        }

    </script>
</body>
</html>
